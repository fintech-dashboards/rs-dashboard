<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RS Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <!-- Chart.js 3.x for financial charts (v4 has compatibility issues with financial plugin) -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@1.28.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-primary: #08090a;
            --bg-secondary: #0d0e10;
            --bg-card: #131417;
            --bg-elevated: #1a1b1f;
            --text-primary: #f4f4f5;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent: #d97706;
            --accent-dim: rgba(217, 119, 6, 0.15);
            --border: #1f2023;
            --border-light: #2a2b2f;
            --green: #10b981;
            --red: #ef4444;
            
            /* Font sizes */
            --fs-xs: 0.75rem;
            --fs-sm: 0.875rem;
            --fs-base: 1rem;
            --fs-lg: 1.125rem;
            --fs-xl: 1.25rem;
            --fs-2xl: 1.5rem;
            --fs-3xl: 2rem;
        }

        [x-cloak] { display: none !important; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: var(--fs-base);
            -webkit-font-smoothing: antialiased;
            letter-spacing: -0.01em;
            min-height: 100vh;
        }

        ::selection {
            background: var(--accent);
            color: var(--bg-primary);
        }

        /* Header */
        header {
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: 0.05em;
            text-transform: uppercase;
            text-decoration: none;
        }

        .logo span {
            color: var(--accent);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-left: auto;
        }

        .header-stats {
            font-size: 1rem;
            color: var(--text-muted);
        }

        .header-stats strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .admin-link {
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            transition: color 0.3s;
        }

        .admin-link:hover {
            color: var(--text-primary);
        }

        /* Buy Me a Coffee */
        .bmc-button {
            display: inline-block;
            padding: 0.5rem 1.25rem;
            background: var(--accent);
            color: var(--bg-primary);
            font-size: 0.9375rem;
            font-weight: 600;
            border-radius: 6px;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(217, 119, 6, 0.3);
        }

        .bmc-button:hover {
            opacity: 0.9;
        }

        .bmc-button.icon-only {
            background: transparent;
            color: var(--accent);
            font-size: 1.5rem;
            padding: 0.25rem 0.5rem;
            box-shadow: none;
        }

        .bmc-button.icon-only:hover {
            opacity: 0.8;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* Main Content */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }

        .breadcrumb a {
            color: var(--accent);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb span {
            color: var(--text-muted);
        }

        /* Section Header */
        .section-header {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .section-subtitle {
            font-size: 0.9375rem;
            color: var(--text-muted);
        }

        /* Table Header */
        .table-header {
            display: grid;
            padding: 0.75rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            margin-bottom: 0.5rem;
        }
        
        .table-header > div[onclick] {
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            transition: color 0.2s;
        }
        
        .table-header > div[onclick]:hover {
            color: var(--accent);
        }
        
        .sort-indicator {
            display: inline-block;
            margin-left: 0.5rem;
            opacity: 0.5;
            font-size: 0.75rem;
            pointer-events: none;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .table-header > div[onclick].sorted .sort-indicator {
            opacity: 1;
            color: var(--accent);
        }

        .table-header.sectors-header {
            grid-template-columns: 1fr 80px 100px 100px 140px;
            gap: 1.5rem;
        }

        .table-header.stocks-header {
            grid-template-columns: 120px 1fr 100px 100px 140px;
            gap: 1.5rem;
        }

        /* Data Row */
        .data-row {
            display: grid;
            align-items: center;
            padding: 1.25rem 1.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }


        .data-row.sectors-row {
            grid-template-columns: 1fr 80px 100px 100px 140px;
            gap: 1.5rem;
        }

        .data-row.stocks-row {
            grid-template-columns: 120px 1fr 100px 100px 140px;
            gap: 1.5rem;
        }

        .row-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .row-secondary {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        /* Strength Badge */
        .strength-badge {
            text-align: center;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9375rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .strength-high {
            background: rgba(16, 185, 129, 0.15);
            color: var(--green);
        }

        .strength-mid {
            background: rgba(217, 119, 6, 0.15);
            color: var(--accent);
        }

        .strength-low {
            background: rgba(239, 68, 68, 0.15);
            color: var(--red);
        }

        .strength-none {
            background: var(--bg-card);
            color: var(--text-muted);
        }

        /* Count */
        .count {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9375rem;
        }

        /* Percentile Badge */
        .percentile-badge {
            display: inline-block;
            padding: 0.375rem 0.75rem;
            border-radius: 999px;
            font-size: 0.875rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .pct-high {
            background: var(--green);
            color: white;
        }

        .pct-mid {
            background: var(--accent);
            color: white;
        }

        .pct-low {
            background: var(--bg-card);
            color: var(--text-muted);
        }

        /* Sparkline Container */
        .sparkline-container {
            display: flex;
            justify-content: center;
        }

        .sparkline {
            width: 120px;
            height: 40px;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        footer a.support-link {
            color: var(--accent);
            text-decoration: none;
            transition: opacity 0.2s;
        }

        footer a.support-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 1100px;
            max-height: 90vh;
            overflow: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 1.75rem;
            cursor: pointer;
            padding: 0;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }
        
        .icon-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.375rem;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            background: var(--bg-elevated);
            color: var(--accent);
            border-color: var(--accent);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border);
            justify-content: center;
        }

        .time-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .time-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        .time-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* canvas max-height removed to allow full expansion */

        /* Slider styling */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--bg-primary);
        }

        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--bg-primary);
        }
    </style>
</head>
<body>
    {% include 'partials/navbar.html' with context %}

    <!-- Main Content -->
    <main>
        {% if view == "sectors" %}
            <!-- Sectors View -->
            <div class="section-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h1 class="section-title">Sectors</h1>
                </div>
                <div style="display: flex; gap: 0.75rem; align-items: center; margin-top: 0.5rem;">
                    <span style="font-size: 0.6875rem; font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase; color: var(--text-muted);">Compare</span>
                    <button onclick="showCompareChart()" style="padding: 0.4rem 0.75rem; background: var(--accent); border: none; color: var(--bg-primary); cursor: pointer; font-size: 0.6875rem; font-weight: 600; letter-spacing: 0.03em; text-transform: uppercase; border-radius: 4px; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Sectors</button>
                    <button onclick="showIndustryCompareModal()" style="padding: 0.4rem 0.75rem; background: var(--accent); border: none; color: var(--bg-primary); cursor: pointer; font-size: 0.6875rem; font-weight: 600; letter-spacing: 0.03em; text-transform: uppercase; border-radius: 4px; transition: opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">Industries</button>
                </div>
            </div>

            <div class="table-header sectors-header" style="grid-template-columns: 1fr 80px 100px 100px 140px;">
                <div onclick="sortDashboardTable(0, 'sectors-row')" style="cursor: pointer;">Sector <span class="sort-indicator">⇅</span></div>
                <div style="text-align: center;">Chart</div>
                <div onclick="sortDashboardTable(2, 'sectors-row')" style="text-align: center; cursor: pointer;">RS Score <span class="sort-indicator">⇅</span></div>
                <div onclick="sortDashboardTable(3, 'sectors-row')" style="text-align: center; cursor: pointer;">Percentile <span class="sort-indicator">⇅</span></div>
                <div style="text-align: center;">Trend (12W)</div>
            </div>

            {% for sector in sectors %}
            <div class="data-row sectors-row" style="cursor: pointer;" onclick="window.location='/sector/{{ sector.sector | urlencode }}'">
                <div class="row-name">{{ sector.sector }}</div>
                <div style="text-align: center;">
                    <button class="icon-btn"
                            onclick="event.stopPropagation(); showSectorChart('{{ sector.sector }}')"
                            title="View RS trend chart">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
                <div class="strength-badge {% if sector.percentile >= 70 %}strength-high{% elif sector.percentile >= 40 %}strength-mid{% else %}strength-low{% endif %}">
                    {{ "%.2f"|format(sector.avg_rs) }}
                </div>
                <div class="percentile-badge {% if sector.percentile >= 70 %}pct-high{% elif sector.percentile >= 40 %}pct-mid{% else %}pct-low{% endif %}">
                    {{ sector.percentile | int }}th
                </div>
                <div class="sparkline-container">
                    <canvas class="sparkline" data-values="{{ sparklines.get(sector.sector, [0]*12) | join(',') }}" data-trend="{% if sparklines.get(sector.sector, [0])[-1] > sparklines.get(sector.sector, [0])[0] %}up{% elif sparklines.get(sector.sector, [0])[-1] < sparklines.get(sector.sector, [0])[0] %}down{% else %}flat{% endif %}"></canvas>
                </div>
            </div>
            {% endfor %}

        {% elif view == "industries" %}
            <!-- Industries View -->
            <div class="breadcrumb">
                <a href="/dashboard">Sectors</a>
                <span>›</span>
                <span>{{ current_sector }}</span>
            </div>

            <div class="section-header">
                <h1 class="section-title">{{ current_sector }}</h1>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <div class="table-header sectors-header" style="flex: 1; margin: 0; grid-template-columns: 1fr 80px 100px 100px 140px;">
                    <div onclick="sortDashboardTable(0, 'sectors-row')" style="cursor: pointer;">Industry <span class="sort-indicator">⇅</span></div>
                    <div style="text-align: center;">Chart</div>
                    <div onclick="sortDashboardTable(2, 'sectors-row')" style="text-align: center; cursor: pointer;">RS Score <span class="sort-indicator">⇅</span></div>
                    <div onclick="sortDashboardTable(3, 'sectors-row')" style="text-align: center; cursor: pointer;">Percentile <span class="sort-indicator">⇅</span></div>
                    <div style="text-align: center;">Trend (12W)</div>
                </div>
                <button onclick="showIndustryCompareChart('{{ current_sector }}')" style="margin-left: 1.5rem; padding: 0.625rem 1.25rem; background: var(--accent-dim); border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; cursor: pointer; font-size: 0.875rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='var(--accent)'; this.style.color='white'" onmouseout="this.style.background='var(--accent-dim)'; this.style.color='var(--accent)'">
                    Compare All
                </button>
            </div>

            {% for ind in industries %}
            <div class="data-row sectors-row" style="cursor: pointer;" onclick="window.location='/industry/{{ ind.industry | urlencode }}'">
                <div class="row-name">{{ ind.industry }}</div>
                <div style="text-align: center;">
                    <button class="icon-btn"
                            onclick="event.stopPropagation(); showIndustryChart('{{ ind.industry }}')"
                            title="View RS trend chart">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
                <div class="strength-badge {% if ind.percentile >= 70 %}strength-high{% elif ind.percentile >= 40 %}strength-mid{% else %}strength-low{% endif %}">
                    {{ "%.2f"|format(ind.rs_score) }}
                </div>
                <div class="percentile-badge {% if ind.percentile >= 70 %}pct-high{% elif ind.percentile >= 40 %}pct-mid{% else %}pct-low{% endif %}">
                    {{ ind.percentile | int }}th
                </div>
                <div class="sparkline-container">
                    <canvas class="sparkline" data-values="{{ sparklines.get(ind.industry, [0]*12) | join(',') }}"></canvas>
                </div>
            </div>
            {% endfor %}

        {% elif view == "stocks" %}
            <!-- Stocks View -->
            <div class="breadcrumb">
                <a href="/dashboard">Sectors</a>
                <span>›</span>
                <a href="/sector/{{ current_sector | urlencode }}">{{ current_sector }}</a>
                <span>›</span>
                <span>{{ current_industry }}</span>
            </div>

            <div class="section-header">
                <h1 class="section-title">{{ current_industry }}</h1>
            </div>

            <div class="table-header stocks-header" style="display: grid; grid-template-columns: 80px 1fr 50px 100px 100px 120px; gap: 1rem; padding: 1rem;">
                <div onclick="sortDashboardTable(0, 'stocks-row')" style="cursor: pointer;">Symbol <span class="sort-indicator">⇅</span></div>
                <div onclick="sortDashboardTable(1, 'stocks-row')" style="cursor: pointer;">Name <span class="sort-indicator">⇅</span></div>
                <div style="text-align: center;">Chart</div>
                <div onclick="sortDashboardTable(3, 'stocks-row')" style="text-align: center; cursor: pointer;">RS Score <span class="sort-indicator">⇅</span></div>
                <div onclick="sortDashboardTable(4, 'stocks-row')" style="text-align: center; cursor: pointer;">Percentile <span class="sort-indicator">⇅</span></div>
                <div style="text-align: center;">RS Score Trend (12W)</div>
            </div>

            {% for stock in stocks %}
            <div class="data-row stocks-row" style="display: grid; grid-template-columns: 80px 1fr 50px 100px 100px 120px; gap: 1rem; padding: 1rem; align-items: center;">
                <div>
                    <a href="https://finance.yahoo.com/quote/{{ stock.symbol }}" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       style="color: var(--accent); text-decoration: none; font-weight: 600;">
                        {{ stock.symbol }}
                    </a>
                </div>
                <div style="color: var(--text-muted); font-size: 0.875rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ stock.name[:40] }}</div>
                <div style="text-align: center;">
                    <button class="icon-btn" 
                            onclick="showStockChart('{{ stock.symbol }}', '{{ stock.name }}')"
                            title="View detailed chart">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
                <div style="text-align: center; font-weight: 600; font-family: 'JetBrains Mono', monospace;">{{ "%.1f"|format(stock.rs_score) }}</div>
                <div style="text-align: center;">
                    <span class="percentile-badge {% if stock.rs_percentile >= 90 %}pct-high{% elif stock.rs_percentile >= 70 %}pct-mid{% else %}pct-low{% endif %}">
                        {{ stock.rs_percentile }}th
                    </span>
                </div>
                <div style="display: flex; justify-content: center;">
                    <canvas class="sparkline" width="120" height="40" data-values="{{ sparklines.get(stock.symbol, [0]*12) | join(',') }}"></canvas>
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </main>

    <footer style="padding: 2rem 3rem; border-top: 1px solid var(--border); max-width: 1400px; margin: 0 auto;">
        <p style="font-size: 0.75rem; color: var(--text-muted); max-width: 800px; margin: 0 auto 1rem; line-height: 1.8; text-align: center;">
            EDUCATIONAL TOOL ONLY. NOT INVESTMENT ADVICE. NO WARRANTIES OR GUARANTEES. USE AT YOUR OWN RISK.
            Open-source code provided as-is with no guarantee of accuracy, completeness, or fitness for any purpose.
            Data sourced by user from Yahoo Finance may be incomplete or inaccurate. User assumes all risk and consequences.
        </p>
        <div style="text-align: center; color: var(--text-muted); font-size: 0.875rem;">
            RS Dashboard • Like this project? <a href="https://buymeacoffee.com/thatfintechguy" target="_blank" rel="noopener noreferrer" style="color: var(--text-muted); text-decoration: none;" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--text-muted)'">☕ Please support</a>
        </div>
    </footer>

    <!-- Chart Modal -->
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="chartTitle">Sector Comparison</h2>
                <button onclick="closeChart()" class="close-btn">✕</button>
            </div>
            <div class="modal-body">
                <canvas id="chartCanvas"></canvas>
            </div>
            <div class="modal-footer">
                <button onclick="loadCurrentCompareChart(30)" class="time-btn">30 Days</button>
                <button onclick="loadCurrentCompareChart(90)" class="time-btn active">90 Days</button>
                <button onclick="loadCurrentCompareChart(180)" class="time-btn">180 Days</button>
            </div>
        </div>
    </div>

    <!-- Stock Chart Modal -->
    <div id="stockChartModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 90vw;">
            <div class="modal-header">
                <h2 id="stockChartTitle">Stock Chart</h2>
                <div style="display: flex; align-items: center; gap: 0.25rem;">
                    <button onclick="zoomStockChart(1)" title="Zoom In" style="width: 32px; height: 32px; background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-primary); border-radius: 4px; cursor: pointer; font-size: 1.25rem; line-height: 1;">+</button>
                    <button onclick="zoomStockChart(-1)" title="Zoom Out" style="width: 32px; height: 32px; background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-primary); border-radius: 4px; cursor: pointer; font-size: 1.25rem; line-height: 1;">−</button>
                    <button onclick="resetStockChartZoom()" title="Reset" style="width: 32px; height: 32px; background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-muted); border-radius: 4px; cursor: pointer; font-size: 0.75rem;">↺</button>
                    <button onclick="closeStockChart()" class="close-btn">✕</button>
                </div>
            </div>
            <div class="modal-body">
                <div style="position: relative; height: 500px;">
                    <canvas id="stockChartCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Industry Compare Modal -->
    <div id="industryCompareModal" class="modal">
        <div class="modal-content" style="max-width: 95vw; width: 95vw; height: 95vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="padding: 1rem 1.5rem;">
                <h2 style="font-size: 1.25rem;">Compare Industries</h2>
                <button onclick="closeIndustryCompareModal()" class="close-btn">✕</button>
            </div>
            <div class="modal-body" style="padding: 1rem 1.5rem 0.5rem; flex: 1; overflow: hidden; min-height: 0;">
                <div style="display: flex; gap: 1.5rem; height: 100%; min-height: 0;">
                    <!-- Left Panel: Industry Selector -->
                    <div id="industrySelectorPanel" style="width: 260px; flex-shrink: 0; background: var(--bg-secondary); border-radius: 8px; padding: 1rem; display: flex; flex-direction: column; overflow: hidden;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <span style="font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted);">Select Industries</span>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="selectAllIndustries()" style="padding: 0.2rem 0.4rem; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 3px; cursor: pointer; font-size: 0.625rem;">All</button>
                                <button onclick="clearAllIndustries()" style="padding: 0.2rem 0.4rem; background: transparent; border: 1px solid var(--border); color: var(--text-muted); border-radius: 3px; cursor: pointer; font-size: 0.625rem;">None</button>
                            </div>
                        </div>
                        <input type="text" id="industrySearchInput" placeholder="Search industries..." oninput="filterIndustryList()" style="width: 100%; padding: 0.5rem 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-primary); border-radius: 4px; font-size: 0.75rem; margin-bottom: 0.5rem; outline: none;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
                        <div style="margin-bottom: 0.75rem; padding: 0.5rem; background: var(--bg-primary); border-radius: 4px;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem;">
                                <input type="checkbox" id="percentileFilterEnabled" onchange="togglePercentileFilter()" style="cursor: pointer; width: 14px; height: 14px;">
                                <span style="font-size: 0.6875rem; color: var(--text-secondary);">Filter by percentile</span>
                                <span id="percentileValue" style="font-size: 0.6875rem; color: var(--accent); font-weight: 600; margin-left: auto; display: none;">≥ 50</span>
                            </label>
                            <input type="range" id="percentileSlider" min="0" max="90" value="50" step="5" oninput="updatePercentileFilter()" style="width: 100%; height: 4px; -webkit-appearance: none; background: var(--border); border-radius: 2px; outline: none; cursor: pointer; opacity: 0.3;" disabled>
                        </div>
                        <div id="sectorIndustryList" style="flex: 1; overflow-y: auto;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    <!-- Right Panel: Chart -->
                    <div style="flex: 1; display: flex; flex-direction: column; min-width: 0; min-height: 0;">
                        <div style="flex: 1; position: relative; min-height: 0;">
                            <canvas id="industryCompareCanvas" style="position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="flex-shrink: 0; padding: 0.75rem 2rem;">
                <button onclick="loadIndustryCompare(30)" class="time-btn">30 Days</button>
                <button onclick="loadIndustryCompare(90)" class="time-btn active" id="industryCompare90">90 Days</button>
                <button onclick="loadIndustryCompare(180)" class="time-btn">180 Days</button>
            </div>
        </div>
    </div>

    <!-- Sparkline Script -->
    <script>
        // Mini sparkline renderer using canvas
        function renderSparklines() {
            document.querySelectorAll('.sparkline').forEach(canvas => {
                const values = canvas.dataset.values.split(',').map(Number);
                const trend = canvas.dataset.trend || 'mid';

                const ctx = canvas.getContext('2d');
                const width = canvas.width = 120;
                const height = canvas.height = 40;

                if (values.length === 0 || values.every(v => v === 0)) {
                    return;
                }

                const max = Math.max(...values);
                const min = Math.min(...values);
                const range = max - min || 1;

                // Color based on trend
                let color;
                if (trend === 'up' || trend === 'high') {
                    color = '#10b981';
                } else if (trend === 'down' || trend === 'low') {
                    color = '#94a3b8';
                } else if (trend === 'mid') {
                    color = '#d97706';
                } else {
                    color = '#64748b';
                }

                // Draw line
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                ctx.beginPath();
                values.forEach((value, i) => {
                    const x = (i / (values.length - 1)) * width;
                    const y = height - ((value - min) / range) * (height - 8) - 4;

                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();

                // Fill area under line
                ctx.lineTo(width, height);
                ctx.lineTo(0, height);
                ctx.closePath();
                ctx.fillStyle = color + '15';
                ctx.fill();
            });
        }

        // Render on load
        document.addEventListener('DOMContentLoaded', renderSparklines);

        // Chart functionality
        let currentChart = null;
        let currentDays = 90;
        let currentCompareType = 'sectors'; // 'sectors' or 'industries'

        function loadCurrentCompareChart(days) {
            if (currentCompareType === 'industries') {
                loadIndustryCompareChart(days);
            } else {
                loadCompareChart(days);
            }
        }

        function showCompareChart() {
            currentCompareType = 'sectors';
            document.getElementById('chartTitle').textContent = 'Sector Comparison';
            document.getElementById('chartModal').style.display = 'flex';
            loadCompareChart(90);
        }

        function closeChart() {
            document.getElementById('chartModal').style.display = 'none';
            if (currentChart) {
                currentChart.destroy();
                currentChart = null;
            }
        }

        async function loadCompareChart(days) {
            currentDays = days;

            // Update active button
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            try {
                const response = await fetch(`/api/chart/all-sectors?days=${days}`);
                const data = await response.json();

                if (currentChart) {
                    currentChart.destroy();
                }

                const colors = [
                    '#d97706', '#10b981', '#3b82f6', '#ef4444', '#8b5cf6',
                    '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
                ];

                const datasets = [];
                let colorIndex = 0;

                for (const [sector, sectorData] of Object.entries(data.sectors)) {
                    if (sectorData.dates && sectorData.dates.length > 0) {
                        const color = colors[colorIndex % colors.length];
                        datasets.push({
                            label: sector,
                            data: sectorData.strength_pct,
                            borderColor: color,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.5,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            cubicInterpolationMode: 'monotone',
                            _originalColor: color
                        });
                        colorIndex++;
                    }
                }

                const firstSector = Object.values(data.sectors)[0];
                const labels = firstSector ? firstSector.dates : [];

                const ctx = document.getElementById('chartCanvas').getContext('2d');
                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        animation: false,
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.2,
                        interaction: {
                            mode: 'dataset',
                            intersect: false
                        },
                        onHover: (event, activeElements, chart) => {
                            if (activeElements.length > 0) {
                                const activeIndex = activeElements[0].datasetIndex;
                                // Highlight active line, fade others
                                chart.data.datasets.forEach((ds, i) => {
                                    if (i === activeIndex) {
                                        ds.borderWidth = 4;
                                        ds.borderColor = ds._originalColor;
                                    } else {
                                        ds.borderWidth = 1.5;
                                        ds.borderColor = ds._originalColor + '70';
                                    }
                                });
                                chart.update('none');
                            } else {
                                // Reset all
                                chart.data.datasets.forEach((ds) => {
                                    ds.borderWidth = 2;
                                    ds.borderColor = ds._originalColor;
                                });
                                chart.update('none');
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#f4f4f5',
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: '#1f2023',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#6b7280',
                                    maxRotation: 45
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Strength %',
                                    color: '#9ca3af',
                                    font: { size: 13, weight: 'bold' }
                                },
                                grid: {
                                    color: '#1f2023',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#6b7280'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading chart:', error);
            }
        }

        // Industry compare chart
        let currentIndustrySector = null;
        let currentIndustryDays = 90;

        function showIndustryCompareChart(sector) {
            currentCompareType = 'industries';
            currentIndustrySector = sector;
            document.getElementById('chartModal').style.display = 'flex';
            document.getElementById('chartTitle').textContent = `${sector} - Industry Comparison`;
            loadIndustryCompareChart(90);
        }

        async function loadIndustryCompareChart(days) {
            currentIndustryDays = days;

            // Update active button
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            try {
                const response = await fetch(`/api/chart/all-industries?sector=${encodeURIComponent(currentIndustrySector)}&days=${days}`);
                const data = await response.json();

                if (currentChart) {
                    currentChart.destroy();
                }

                const colors = [
                    '#d97706', '#10b981', '#3b82f6', '#ef4444', '#8b5cf6',
                    '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
                    '#14b8a6', '#f43f5e', '#a855f7', '#22c55e', '#eab308'
                ];

                const datasets = [];
                let colorIndex = 0;

                for (const [industry, industryData] of Object.entries(data.industries)) {
                    if (industryData.dates && industryData.dates.length > 0) {
                        const color = colors[colorIndex % colors.length];
                        datasets.push({
                            label: industry,
                            data: industryData.strength_pct,
                            borderColor: color,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.5,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            cubicInterpolationMode: 'monotone',
                            _originalColor: color
                        });
                        colorIndex++;
                    }
                }

                const firstIndustry = Object.values(data.industries)[0];
                const labels = firstIndustry ? firstIndustry.dates : [];

                const ctx = document.getElementById('chartCanvas').getContext('2d');
                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        animation: false,
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.2,
                        interaction: {
                            mode: 'dataset',
                            intersect: false
                        },
                        onHover: (event, activeElements, chart) => {
                            if (activeElements.length > 0) {
                                const activeIndex = activeElements[0].datasetIndex;
                                chart.data.datasets.forEach((ds, i) => {
                                    if (i === activeIndex) {
                                        ds.borderWidth = 4;
                                        ds.borderColor = ds._originalColor;
                                    } else {
                                        ds.borderWidth = 1.5;
                                        ds.borderColor = ds._originalColor + '70';
                                    }
                                });
                                chart.update('none');
                            } else {
                                chart.data.datasets.forEach((ds) => {
                                    ds.borderWidth = 2;
                                    ds.borderColor = ds._originalColor;
                                });
                                chart.update('none');
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#f4f4f5',
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: '#1f2023',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#6b7280',
                                    maxRotation: 45
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'RS Score',
                                    color: '#9ca3af',
                                    font: { size: 13, weight: 'bold' }
                                },
                                grid: {
                                    color: '#1f2023',
                                    drawBorder: false
                                },
                                ticks: {
                                    color: '#6b7280'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading industry chart:', error);
            }
        }

        // Stock chart functions
        let stockChartInstance = null;

        function resetStockChartZoom() {
            if (stockChartInstance) {
                stockChartInstance.resetZoom();
            }
        }

        function zoomStockChart(direction) {
            if (stockChartInstance) {
                if (direction > 0) {
                    stockChartInstance.zoom(1.2);
                } else {
                    stockChartInstance.zoom(0.8);
                }
            }
        }

        async function showStockChart(symbol, name) {
            document.getElementById('stockChartModal').style.display = 'flex';
            document.getElementById('stockChartTitle').textContent = `${symbol} - ${name}`;
            
            try {
                const response = await fetch(`/api/chart/ticker/${symbol}`);
                const data = await response.json();
                renderStockChart(data);
            } catch (error) {
                console.error('Failed to load stock chart:', error);
            }
        }
        
        function closeStockChart() {
            document.getElementById('stockChartModal').style.display = 'none';
            if (stockChartInstance) {
                stockChartInstance.destroy();
                stockChartInstance = null;
            }
        }

        // Sector and Industry Chart Functions
        async function showSectorChart(sectorName) {
            document.getElementById('stockChartModal').style.display = 'flex';
            document.getElementById('stockChartTitle').textContent = `${sectorName} - RS Trend`;

            try {
                const response = await fetch(`/api/chart/sector/${encodeURIComponent(sectorName)}`);
                const data = await response.json();
                renderSectorIndustryChart(data, sectorName, 'Sector');
            } catch (error) {
                console.error('Failed to load sector chart:', error);
            }
        }

        async function showIndustryChart(industryName) {
            document.getElementById('stockChartModal').style.display = 'flex';
            document.getElementById('stockChartTitle').textContent = `${industryName} - RS Trend`;

            try {
                const response = await fetch(`/api/chart/industry/${encodeURIComponent(industryName)}`);
                const data = await response.json();
                renderSectorIndustryChart(data, industryName, 'Industry');
            } catch (error) {
                console.error('Failed to load industry chart:', error);
            }
        }

        function renderSectorIndustryChart(data, name, type) {
            if (stockChartInstance) {
                stockChartInstance.destroy();
                stockChartInstance = null;
            }

            const { dates, returns, benchmark_returns } = data;
            if (!dates || dates.length === 0) return;

            const canvas = document.getElementById('stockChartCanvas');
            const ctx = canvas.getContext('2d');

            // Clear any existing chart
            Chart.getChart(canvas)?.destroy();

            // Convert to line chart data (cumulative returns baselined to 100)
            const entityLine = dates.map((date, i) => ({
                x: luxon.DateTime.fromISO(date).valueOf(),
                y: returns[i]
            })).filter(d => d.y !== null);

            // SPY benchmark line
            const benchmarkLine = dates.map((date, i) => ({
                x: luxon.DateTime.fromISO(date).valueOf(),
                y: benchmark_returns[i]
            })).filter(d => d.y !== null);

            stockChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: name,
                        data: entityLine,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.2,
                        fill: true
                    }, {
                        label: 'SPY (Benchmark)',
                        data: benchmarkLine,
                        borderColor: '#f59e0b',
                        borderDash: [5, 5],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.2
                    }]
                },
                options: {
                    animation: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#9ca3af',
                                font: { size: 14, weight: '600' },
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1b1f',
                            titleColor: '#f4f4f5',
                            bodyColor: '#9ca3af',
                            borderColor: '#2a2b2f',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const val = context.parsed.y;
                                    const change = (val - 100).toFixed(2);
                                    const prefix = change >= 0 ? '+' : '';
                                    return `${context.dataset.label}: ${val.toFixed(2)} (${prefix}${change}%)`;
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x',
                            },
                            zoom: {
                                wheel: { enabled: false },
                                pinch: { enabled: false },
                                drag: { enabled: false },
                                mode: 'x',
                            },
                            limits: {
                                x: { min: entityLine.length > 0 ? entityLine[0].x : null, max: entityLine.length > 0 ? entityLine[entityLine.length - 1].x : null, minRange: 7 * 24 * 60 * 60 * 1000 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            min: entityLine.length > 0 ? entityLine[0].x : null,
                            max: entityLine.length > 0 ? entityLine[entityLine.length - 1].x : null,
                            time: {
                                unit: 'week',
                                displayFormats: { week: 'MMM d' }
                            },
                            grid: { color: '#1f2023' },
                            ticks: { color: '#6b7280', font: { size: 11 } }
                        },
                        y: {
                            position: 'left',
                            title: { display: true, text: 'Cumulative Return (baselined to 100)', color: '#9ca3af', font: { size: 12 } },
                            grid: { color: '#1f2023' },
                            ticks: { color: '#6b7280', font: { size: 11 } }
                        }
                    }
                }
            });
        }

        function renderStockChart(data) {
            if (stockChartInstance) {
                stockChartInstance.destroy();
                stockChartInstance = null;
            }

            const { dates, ohlc, rs_scores } = data;
            if (!dates || dates.length === 0) return;

            const canvas = document.getElementById('stockChartCanvas');
            const ctx = canvas.getContext('2d');

            // Clear any existing chart instance from canvas
            Chart.getChart(canvas)?.destroy();

            // Convert dates to timestamps for candlestick chart
            const ohlcData = dates.map((date, i) => ({
                x: luxon.DateTime.fromISO(date).valueOf(),
                o: ohlc[i].o,
                h: ohlc[i].h,
                l: ohlc[i].l,
                c: ohlc[i].c
            }));

            const rsLineData = dates.map((date, i) => ({
                x: luxon.DateTime.fromISO(date).valueOf(),
                y: rs_scores[i]
            })).filter(d => d.y !== null);

            stockChartInstance = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: 'Price',
                        data: ohlcData,
                        yAxisID: 'y',
                        color: {
                            up: '#10b981',
                            down: '#ef4444',
                            unchanged: '#6b7280'
                        }
                    }, {
                        label: 'RS Score',
                        type: 'line',
                        data: rsLineData,
                        yAxisID: 'y1',
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.2
                    }]
                },
                options: {
                    animation: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#9ca3af',
                                font: { size: 14, weight: '600' },
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#1a1b1f',
                            titleColor: '#f4f4f5',
                            bodyColor: '#9ca3af',
                            borderColor: '#2a2b2f',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Price') {
                                        const data = context.raw;
                                        return [
                                            `Open: $${data.o.toFixed(2)}`,
                                            `High: $${data.h.toFixed(2)}`,
                                            `Low: $${data.l.toFixed(2)}`,
                                            `Close: $${data.c.toFixed(2)}`
                                        ];
                                    } else {
                                        return `RS: ${context.parsed.y.toFixed(1)}`;
                                    }
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x',
                            },
                            zoom: {
                                wheel: { enabled: false },
                                pinch: { enabled: false },
                                drag: { enabled: false },
                                mode: 'x',
                            },
                            limits: {
                                x: { min: ohlcData.length > 0 ? ohlcData[0].x : null, max: ohlcData.length > 0 ? ohlcData[ohlcData.length - 1].x : null, minRange: 7 * 24 * 60 * 60 * 1000 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            min: ohlcData.length > 0 ? ohlcData[0].x : null,
                            max: ohlcData.length > 0 ? ohlcData[ohlcData.length - 1].x : null,
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM d'
                                }
                            },
                            grid: {
                                color: '#1f2023'
                            },
                            ticks: {
                                color: '#6b7280',
                                font: { size: 11 }
                            }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Price ($)',
                                color: '#10b981',
                                font: { size: 12 }
                            },
                            grid: {
                                color: '#1f2023'
                            },
                            ticks: {
                                color: '#6b7280',
                                font: { size: 11 },
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'RS Score',
                                color: '#f59e0b',
                                font: { size: 12 }
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                color: '#f59e0b',
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        }

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeChart();
                closeStockChart();
                closeIndustryCompareModal();
            }
        });

        // Close modal on background click
        document.addEventListener('click', (e) => {
            if (e.target.id === 'chartModal') closeChart();
            if (e.target.id === 'stockChartModal') closeStockChart();
            if (e.target.id === 'industryCompareModal') closeIndustryCompareModal();
        });

        // Dashboard table sorting - optimized
        let dashboardSortState = {};

        function sortDashboardTable(columnIndex, tableClass) {
            const rows = Array.from(document.querySelectorAll(`.data-row.${tableClass}`));
            if (rows.length === 0) return;

            const headers = document.querySelectorAll(`.table-header.${tableClass} > div[onclick]`);
            const header = headers[columnIndex];

            // Toggle sort direction
            const key = `${tableClass}-${columnIndex}`;
            const isAscending = dashboardSortState[key] !== true;
            dashboardSortState[key] = isAscending;

            // Update header indicators
            headers.forEach((h, idx) => {
                h.classList.toggle('sorted', idx === columnIndex);
                const indicator = h.querySelector('.sort-indicator');
                if (indicator) {
                    if (idx === columnIndex) {
                        indicator.textContent = isAscending ? '↑' : '↓';
                        indicator.style.opacity = '1';
                    } else {
                        indicator.textContent = '⇅';
                        indicator.style.opacity = '0.5';
                    }
                }
            });

            // Sort rows
            rows.sort((a, b) => {
                let aVal = a.children[columnIndex]?.textContent.trim() || '';
                let bVal = b.children[columnIndex]?.textContent.trim() || '';

                // Remove % and parse as number
                aVal = aVal.replace('%', '').trim();
                bVal = bVal.replace('%', '').trim();

                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAscending ? aNum - bNum : bNum - aNum;
                }

                return isAscending
                    ? aVal.localeCompare(bVal)
                    : bVal.localeCompare(aVal);
            });

            // Re-append sorted rows in batch
            const container = rows[0]?.parentElement;
            if (container) {
                const fragment = document.createDocumentFragment();
                rows.forEach(row => fragment.appendChild(row));
                container.appendChild(fragment);
            }
        }

        // Industry Compare Modal
        let sectorIndustryHierarchy = {};
        let selectedIndustries = new Set();
        let expandedSectors = new Set();
        let industryCompareChart = null;
        let industryCompareDays = 90;

        async function showIndustryCompareModal() {
            document.getElementById('industryCompareModal').style.display = 'flex';

            // Fetch hierarchy if not loaded
            if (Object.keys(sectorIndustryHierarchy).length === 0) {
                try {
                    const response = await fetch('/api/sectors-industries');
                    const data = await response.json();
                    sectorIndustryHierarchy = data.sectors;
                    renderSectorIndustryList();
                } catch (error) {
                    console.error('Error fetching hierarchy:', error);
                }
            }
        }

        function closeIndustryCompareModal() {
            document.getElementById('industryCompareModal').style.display = 'none';
            if (industryCompareChart) {
                industryCompareChart.destroy();
                industryCompareChart = null;
            }
        }

        let industrySearchTerm = '';
        let minPercentile = 50;
        let percentileFilterEnabled = false;

        function filterIndustryList() {
            industrySearchTerm = document.getElementById('industrySearchInput').value.toLowerCase();
            renderSectorIndustryList();
        }

        function togglePercentileFilter() {
            percentileFilterEnabled = document.getElementById('percentileFilterEnabled').checked;
            const slider = document.getElementById('percentileSlider');
            const valueLabel = document.getElementById('percentileValue');

            if (percentileFilterEnabled) {
                slider.disabled = false;
                slider.style.opacity = '1';
                valueLabel.style.display = 'block';
            } else {
                slider.disabled = true;
                slider.style.opacity = '0.3';
                valueLabel.style.display = 'none';
            }
            renderSectorIndustryList();
        }

        function updatePercentileFilter() {
            minPercentile = parseInt(document.getElementById('percentileSlider').value);
            document.getElementById('percentileValue').textContent = '≥ ' + minPercentile;
            renderSectorIndustryList();
        }

        function renderSectorIndustryList() {
            const container = document.getElementById('sectorIndustryList');
            container.innerHTML = '';

            const sectors = Object.keys(sectorIndustryHierarchy).sort();

            sectors.forEach(sector => {
                let industries = sectorIndustryHierarchy[sector];

                // Filter industries by search term and percentile (if enabled)
                const filteredIndustries = industries.filter(ind => {
                    const name = ind.name || ind;
                    const pct = ind.percentile || 0;
                    const matchesSearch = !industrySearchTerm || name.toLowerCase().includes(industrySearchTerm);
                    const matchesPercentile = !percentileFilterEnabled || pct >= minPercentile;
                    return matchesSearch && matchesPercentile;
                });

                // Skip sector if no matching industries
                if (filteredIndustries.length === 0) return;

                const isExpanded = expandedSectors.has(sector) || industrySearchTerm || percentileFilterEnabled;
                const allIndustryNames = industries.map(i => i.name || i);
                const filteredNames = filteredIndustries.map(i => i.name || i);
                const selectedCount = allIndustryNames.filter(i => selectedIndustries.has(i)).length;
                const allSelected = selectedCount === allIndustryNames.length && allIndustryNames.length > 0;
                const someSelected = selectedCount > 0 && selectedCount < allIndustryNames.length;

                const sectorDiv = document.createElement('div');
                sectorDiv.style.marginBottom = '0.375rem';
                sectorDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.5rem; background: var(--bg-elevated); border-radius: 4px; cursor: pointer;" onclick="toggleSectorExpand('${sector}')">
                        <span style="font-size: 0.625rem; color: var(--text-muted); width: 10px;">${isExpanded ? '▼' : '▶'}</span>
                        <input type="checkbox"
                               ${allSelected ? 'checked' : ''}
                               ${someSelected ? 'style="opacity: 0.5;"' : ''}
                               onclick="event.stopPropagation(); toggleSector('${sector}')"
                               style="cursor: pointer; width: 14px; height: 14px;">
                        <span style="font-size: 0.75rem; font-weight: 500; flex: 1;">${sector}</span>
                        <span style="font-size: 0.625rem; color: var(--text-muted);">${filteredIndustries.length}</span>
                    </div>
                    ${isExpanded ? `
                        <div style="margin-left: 1.25rem; margin-top: 0.125rem;">
                            ${filteredIndustries.map(ind => {
                                const name = ind.name || ind;
                                const pct = Math.round(ind.percentile || 0);
                                return `
                                <label style="display: flex; align-items: center; gap: 0.4rem; padding: 0.25rem 0.4rem; cursor: pointer; border-radius: 3px; transition: background 0.15s;" onmouseover="this.style.background='var(--bg-elevated)'" onmouseout="this.style.background='transparent'">
                                    <input type="checkbox"
                                           ${selectedIndustries.has(name) ? 'checked' : ''}
                                           onchange="toggleIndustry('${name.replace(/'/g, "\\'")}')"
                                           style="cursor: pointer; width: 13px; height: 13px;">
                                    <span style="font-size: 0.6875rem; color: var(--text-secondary); flex: 1;">${industrySearchTerm ? name.replace(new RegExp(industrySearchTerm, 'gi'), '<mark style="background: var(--accent); color: var(--bg-primary); padding: 0 2px; border-radius: 2px;">$&</mark>') : name}</span>
                                    <span style="font-size: 0.5625rem; color: ${pct >= 70 ? 'var(--green)' : pct >= 40 ? 'var(--accent)' : 'var(--text-muted)'}; font-weight: 500;">${pct}</span>
                                </label>
                            `}).join('')}
                        </div>
                    ` : ''}
                `;
                container.appendChild(sectorDiv);
            });
        }

        function toggleSectorExpand(sector) {
            if (expandedSectors.has(sector)) {
                expandedSectors.delete(sector);
            } else {
                expandedSectors.add(sector);
            }
            renderSectorIndustryList();
        }

        function toggleSector(sector) {
            const industries = sectorIndustryHierarchy[sector];
            const industryNames = industries.map(i => i.name || i);
            const allSelected = industryNames.every(i => selectedIndustries.has(i));

            if (allSelected) {
                industryNames.forEach(i => selectedIndustries.delete(i));
            } else {
                industryNames.forEach(i => selectedIndustries.add(i));
            }

            renderSectorIndustryList();
            loadIndustryCompare(industryCompareDays);
        }

        function toggleIndustry(industry) {
            if (selectedIndustries.has(industry)) {
                selectedIndustries.delete(industry);
            } else {
                selectedIndustries.add(industry);
            }
            renderSectorIndustryList();
            loadIndustryCompare(industryCompareDays);
        }

        function selectAllIndustries() {
            // Only select visible/filtered industries
            Object.values(sectorIndustryHierarchy).flat().forEach(i => {
                const name = i.name || i;
                const pct = i.percentile || 0;
                const matchesSearch = !industrySearchTerm || name.toLowerCase().includes(industrySearchTerm);
                const matchesPercentile = !percentileFilterEnabled || pct >= minPercentile;
                if (matchesSearch && matchesPercentile) {
                    selectedIndustries.add(name);
                }
            });
            renderSectorIndustryList();
            loadIndustryCompare(industryCompareDays);
        }

        function clearAllIndustries() {
            selectedIndustries.clear();
            renderSectorIndustryList();
            if (industryCompareChart) {
                industryCompareChart.destroy();
                industryCompareChart = null;
            }
        }

        async function loadIndustryCompare(days) {
            industryCompareDays = days;

            // Update active button
            document.querySelectorAll('#industryCompareModal .time-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(days)) btn.classList.add('active');
            });

            if (selectedIndustries.size === 0) {
                if (industryCompareChart) {
                    industryCompareChart.destroy();
                    industryCompareChart = null;
                }
                return;
            }

            try {
                const industries = Array.from(selectedIndustries).join(',');
                const response = await fetch(`/api/chart/compare-industries?industries=${encodeURIComponent(industries)}&days=${days}`);
                const data = await response.json();

                if (industryCompareChart) {
                    industryCompareChart.destroy();
                }

                const colors = [
                    '#d97706', '#10b981', '#3b82f6', '#ef4444', '#8b5cf6',
                    '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
                    '#14b8a6', '#f43f5e', '#a855f7', '#22c55e', '#eab308',
                    '#0ea5e9', '#f472b6', '#a3e635', '#fb923c', '#818cf8'
                ];

                const datasets = [];
                let colorIndex = 0;

                for (const [industry, industryData] of Object.entries(data.industries)) {
                    if (industryData.dates && industryData.dates.length > 0) {
                        const color = colors[colorIndex % colors.length];
                        datasets.push({
                            label: industry,
                            data: industryData.rs_scores,
                            borderColor: color,
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            _originalColor: color
                        });
                        colorIndex++;
                    }
                }

                const firstIndustry = Object.values(data.industries)[0];
                const labels = firstIndustry ? firstIndustry.dates : [];

                // Format dates nicely
                const formattedLabels = labels.map(d => {
                    const date = new Date(d);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                const ctx = document.getElementById('industryCompareCanvas').getContext('2d');
                industryCompareChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: formattedLabels, datasets },
                    options: {
                        animation: false,
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'dataset',
                            intersect: false
                        },
                        onHover: (event, activeElements, chart) => {
                            if (activeElements.length > 0) {
                                const activeIndex = activeElements[0].datasetIndex;
                                chart.data.datasets.forEach((ds, i) => {
                                    if (i === activeIndex) {
                                        ds.borderWidth = 4;
                                        ds.borderColor = ds._originalColor;
                                    } else {
                                        ds.borderWidth = 1;
                                        ds.borderColor = ds._originalColor + '25';
                                    }
                                });
                                chart.update('none');
                            } else {
                                chart.data.datasets.forEach((ds) => {
                                    ds.borderWidth = 1.5;
                                    ds.borderColor = ds._originalColor;
                                });
                                chart.update('none');
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0,0,0,0.9)',
                                titleColor: '#f4f4f5',
                                titleFont: { size: 13, weight: '600' },
                                bodyFont: { size: 0 },
                                padding: 10,
                                displayColors: false,
                                callbacks: {
                                    title: (context) => context[0].dataset.label,
                                    label: () => ''
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: '#1f2023' },
                                ticks: {
                                    color: '#6b7280',
                                    maxRotation: 0,
                                    maxTicksLimit: 10,
                                    font: { size: 11 }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'RS Score',
                                    color: '#9ca3af',
                                    font: { size: 12, weight: 'bold' }
                                },
                                grid: { color: '#1f2023' },
                                ticks: { color: '#6b7280' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading industry comparison:', error);
            }
        }

    </script>
</body>
</html>

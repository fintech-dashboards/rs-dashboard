{# Ticker Table Component - Client-side sorting & pagination with Alpine.js #}
{% if tickers | length == 0 %}
<!-- Empty State -->
<div style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
    <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--text-muted); font-weight: 300;">[ ]</div>
    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 500;">No Tickers Yet</h3>
    <p style="margin-bottom: 1.5rem;">Get started by adding tickers to track their Relative Strength</p>
    <button class="btn-primary" @click="$dispatch('show-add-modal')">
        + Add Tickers
    </button>
</div>
{% else %}

<div x-data="tickerTable()" x-init="init()">
    <!-- Pagination Info -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <span style="color: var(--text-muted); font-size: 0.875rem;">
            Showing <span x-text="startIdx + 1"></span> to <span x-text="Math.min(endIdx, allTickers.length)"></span> of <span x-text="allTickers.length"></span> tickers
        </span>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <label style="color: var(--text-muted); font-size: 0.875rem;">Per page:</label>
            <select x-model="perPage" @change="page = 1" style="padding: 0.25rem 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);">
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="all">All</option>
            </select>
        </div>
    </div>

    <!-- Table -->
    <table>
        <thead>
            <tr>
                <th @click="sort('symbol')" style="cursor: pointer;">
                    Symbol <span x-text="sortIndicator('symbol')"></span>
                </th>
                <th @click="sort('name')" style="cursor: pointer;">
                    Name <span x-text="sortIndicator('name')"></span>
                </th>
                <th @click="sort('sector')" style="cursor: pointer;">
                    Sector <span x-text="sortIndicator('sector')"></span>
                </th>
                <th @click="sort('industry')" style="cursor: pointer;">
                    Industry <span x-text="sortIndicator('industry')"></span>
                </th>
                <th @click="sort('price_count')" style="cursor: pointer;">
                    Prices <span x-text="sortIndicator('price_count')"></span>
                </th>
                <th>RS Status</th>
                <th @click="sort('rs_score')" style="cursor: pointer;">
                    RS Score <span x-text="sortIndicator('rs_score')"></span>
                </th>
                <th @click="sort('rs_percentile')" style="cursor: pointer;">
                    Percentile <span x-text="sortIndicator('rs_percentile')"></span>
                </th>
                <th>View</th>
            </tr>
        </thead>
        <tbody>
            <template x-for="ticker in paginatedTickers" :key="ticker.symbol">
                <tr>
                    <td>
                        <a :href="'https://finance.yahoo.com/quote/' + ticker.symbol"
                           target="_blank"
                           rel="noopener noreferrer"
                           style="color: var(--accent); text-decoration: none; font-weight: 600;"
                           x-text="ticker.symbol"></a>
                    </td>
                    <td x-text="(ticker.name || '—').substring(0, 25)"></td>
                    <td x-text="ticker.sector || '—'"></td>
                    <td x-text="(ticker.industry || '—').substring(0, 20)"></td>
                    <td>
                        <span :class="'status status-' + ticker.price_status">
                            <span x-text="ticker.price_status.toUpperCase()"></span>
                            <span x-show="ticker.price_status === 'complete'" x-text="' • ' + ticker.price_count + 'd'"></span>
                        </span>
                    </td>
                    <td>
                        <span :class="'status status-' + ticker.rs_status">
                            <span x-text="ticker.rs_status.toUpperCase()"></span>
                        </span>
                    </td>
                    <td>
                        <template x-if="ticker.rs_score">
                            <span :class="'score ' + (ticker.rs_score >= 110 ? 'score-high' : ticker.rs_score >= 90 ? 'score-mid' : 'score-low')"
                                  x-text="ticker.rs_score.toFixed(1)"></span>
                        </template>
                        <template x-if="!ticker.rs_score">
                            <span>—</span>
                        </template>
                    </td>
                    <td x-text="ticker.rs_percentile ? ticker.rs_percentile + 'th' : '—'"></td>
                    <td>
                        <template x-if="ticker.price_status === 'complete'">
                            <button class="icon-btn"
                                    @click="$dispatch('show-chart-modal', { symbol: ticker.symbol, name: ticker.name })"
                                    title="View detailed chart">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </template>
                        <template x-if="ticker.price_status !== 'complete'">
                            <span>—</span>
                        </template>
                    </td>
                </tr>
            </template>
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <div x-show="totalPages > 1" style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 4px;">
        <button @click="page = 1" :disabled="page === 1" class="pagination-btn" style="padding: 0.5rem 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer;">««</button>
        <button @click="page = Math.max(1, page - 1)" :disabled="page === 1" class="pagination-btn" style="padding: 0.5rem 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer;">‹</button>
        <span style="color: var(--text-secondary); font-size: 0.875rem; padding: 0 1rem;">
            Page <span x-text="page"></span> of <span x-text="totalPages"></span>
        </span>
        <button @click="page = Math.min(totalPages, page + 1)" :disabled="page === totalPages" class="pagination-btn" style="padding: 0.5rem 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer;">›</button>
        <button @click="page = totalPages" :disabled="page === totalPages" class="pagination-btn" style="padding: 0.5rem 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer;">»»</button>
    </div>
</div>

<script>
function tickerTable() {
    return {
        allTickers: {{ tickers | tojson }},
        sortBy: 'symbol',
        sortDir: 'asc',
        page: 1,
        perPage: '50',

        init() {
            // Default sort by symbol
            this.sortData();
        },

        get perPageNum() {
            return this.perPage === 'all' ? this.allTickers.length : parseInt(this.perPage);
        },

        get totalPages() {
            return Math.ceil(this.allTickers.length / this.perPageNum);
        },

        get startIdx() {
            return (this.page - 1) * this.perPageNum;
        },

        get endIdx() {
            return this.startIdx + this.perPageNum;
        },

        get paginatedTickers() {
            return this.allTickers.slice(this.startIdx, this.endIdx);
        },

        sort(column) {
            if (this.sortBy === column) {
                this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortBy = column;
                this.sortDir = 'asc';
            }
            this.sortData();
            this.page = 1;
        },

        sortData() {
            const dir = this.sortDir === 'asc' ? 1 : -1;
            const col = this.sortBy;

            this.allTickers.sort((a, b) => {
                let aVal = a[col];
                let bVal = b[col];

                // Handle nulls
                if (aVal === null || aVal === undefined) aVal = col === 'rs_score' || col === 'rs_percentile' || col === 'price_count' ? -999 : '';
                if (bVal === null || bVal === undefined) bVal = col === 'rs_score' || col === 'rs_percentile' || col === 'price_count' ? -999 : '';

                // Numeric comparison for number fields
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return (aVal - bVal) * dir;
                }

                // String comparison
                return String(aVal).localeCompare(String(bVal)) * dir;
            });
        },

        sortIndicator(column) {
            if (this.sortBy !== column) return '⇅';
            return this.sortDir === 'asc' ? '↑' : '↓';
        }
    };
}
</script>
{% endif %}

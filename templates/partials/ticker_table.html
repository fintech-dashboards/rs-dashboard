{# Ticker Table Component with Server-Side Sorting #}
<!-- Hidden inputs to track sort state -->
<input type="hidden" name="sort_by" value="{{ sort_by or 'symbol' }}">
<input type="hidden" name="sort_dir" value="{{ sort_dir or 'asc' }}">

{% if tickers | length == 0 %}
<!-- Empty State -->
<div style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
    <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--text-muted); font-weight: 300;">[ ]</div>
    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 500;">No Tickers Yet</h3>
    <p style="margin-bottom: 1.5rem;">Get started by adding tickers to track their Relative Strength</p>
    <button class="btn-primary" @click="$dispatch('show-add-modal')">
        + Add Tickers
    </button>
</div>
{% else %}

{# Macro for sortable header #}
{% macro sort_header(column, label, current_sort, current_dir) %}
{% set new_dir = 'desc' if current_sort == column and current_dir == 'asc' else 'asc' %}
<th hx-get="/api/ticker-table-html?sort_by={{ column }}&sort_dir={{ new_dir }}&page=1&per_page={{ per_page }}&filter={{ filter }}&sector={{ sector }}&industry={{ industry }}&search={{ search }}"
    hx-target="#ticker-table"
    hx-swap="innerHTML"
    style="cursor: pointer; user-select: none;">
    {{ label }}
    <span class="sort-indicator" style="{% if current_sort == column %}color: var(--accent); opacity: 1;{% endif %}">
        {% if current_sort == column %}
            {{ '↑' if current_dir == 'asc' else '↓' }}
        {% else %}
            ⇅
        {% endif %}
    </span>
</th>
{% endmacro %}

<!-- Table -->
<table>
    <thead>
        <tr>
            {{ sort_header('symbol', 'Symbol', sort_by, sort_dir) }}
            {{ sort_header('name', 'Name', sort_by, sort_dir) }}
            {{ sort_header('sector', 'Sector', sort_by, sort_dir) }}
            {{ sort_header('industry', 'Industry', sort_by, sort_dir) }}
            {{ sort_header('price_count', 'Prices', sort_by, sort_dir) }}
            <th>RS Status</th>
            {{ sort_header('rs_score', 'RS Score', sort_by, sort_dir) }}
            {{ sort_header('rs_percentile', 'Percentile', sort_by, sort_dir) }}
            <th>View</th>
        </tr>
    </thead>
    <tbody>
        {% for ticker in tickers %}
        <tr>
            <td>
                <a href="https://finance.yahoo.com/quote/{{ ticker.symbol }}"
                   target="_blank"
                   rel="noopener noreferrer"
                   style="color: var(--accent); text-decoration: none; font-weight: 600;">
                    {{ ticker.symbol }}
                </a>
            </td>
            <td>{{ (ticker.name or '—')[:25] }}</td>
            <td>{{ ticker.sector or '—' }}</td>
            <td>{{ (ticker.industry or '—')[:20] }}</td>
            <td>
                <span class="status status-{{ ticker.price_status }}">
                    <span>{{ ticker.price_status | upper }}</span>
                    {% if ticker.price_status == 'complete' %}
                    <span> • {{ ticker.price_count }}d</span>
                    {% endif %}
                </span>
            </td>
            <td>
                <span class="status status-{{ ticker.rs_status }}">
                    <span>{{ ticker.rs_status | upper }}</span>
                </span>
            </td>
            <td>
                {% if ticker.rs_score %}
                <span class="score {% if ticker.rs_score >= 110 %}score-high{% elif ticker.rs_score >= 90 %}score-mid{% else %}score-low{% endif %}">
                    {{ "%.1f" | format(ticker.rs_score) }}
                </span>
                {% else %}
                —
                {% endif %}
            </td>
            <td>{% if ticker.rs_percentile %}{{ ticker.rs_percentile }}th{% else %}—{% endif %}</td>
            <td>
                {% if ticker.price_status == 'complete' %}
                <button class="icon-btn"
                        @click='$dispatch("show-chart-modal", { symbol: "{{ ticker.symbol }}", name: "{{ ticker.name }}" })'
                        title="View detailed chart">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                </button>
                {% else %}
                —
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination Controls -->
{% if total_pages > 1 %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: 4px;">
    <!-- Page Info -->
    <div style="color: var(--text-secondary); font-size: 0.875rem;">
        Showing {{ (page - 1) * per_page + 1 }} to {{ [(page * per_page), total_items] | min }} of {{ total_items }} tickers
    </div>

    <!-- Pagination Buttons -->
    <div style="display: flex; gap: 0.5rem; align-items: center;">
        <!-- First Page -->
        <button
            hx-get="/api/ticker-table-html?page=1&per_page={{ per_page }}&filter={{ filter }}&sector={{ sector }}&industry={{ industry }}&search={{ search }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}"
            hx-target="#ticker-table"
            hx-swap="innerHTML"
            class="pagination-btn"
            {% if page == 1 %}disabled{% endif %}
            style="padding: 0.5rem 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.875rem;"
        >
            ««
        </button>

        <!-- Previous Page -->
        <button
            hx-get="/api/ticker-table-html?page={{ page - 1 }}&per_page={{ per_page }}&filter={{ filter }}&sector={{ sector }}&industry={{ industry }}&search={{ search }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}"
            hx-target="#ticker-table"
            hx-swap="innerHTML"
            class="pagination-btn"
            {% if page == 1 %}disabled{% endif %}
            style="padding: 0.5rem 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.875rem;"
        >
            ‹
        </button>

        <!-- Page Numbers -->
        <span style="color: var(--text-secondary); font-size: 0.875rem; padding: 0 0.5rem;">
            Page {{ page }} of {{ total_pages }}
        </span>

        <!-- Next Page -->
        <button
            hx-get="/api/ticker-table-html?page={{ page + 1 }}&per_page={{ per_page }}&filter={{ filter }}&sector={{ sector }}&industry={{ industry }}&search={{ search }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}"
            hx-target="#ticker-table"
            hx-swap="innerHTML"
            class="pagination-btn"
            {% if page == total_pages %}disabled{% endif %}
            style="padding: 0.5rem 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.875rem;"
        >
            ›
        </button>

        <!-- Last Page -->
        <button
            hx-get="/api/ticker-table-html?page={{ total_pages }}&per_page={{ per_page }}&filter={{ filter }}&sector={{ sector }}&industry={{ industry }}&search={{ search }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}"
            hx-target="#ticker-table"
            hx-swap="innerHTML"
            class="pagination-btn"
            {% if page == total_pages %}disabled{% endif %}
            style="padding: 0.5rem 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.875rem;"
        >
            »»
        </button>

        <!-- Per Page Selector -->
        <select
            hx-get="/api/ticker-table-html"
            hx-target="#ticker-table"
            hx-swap="innerHTML"
            hx-include="[name='filter'], [name='sector'], [name='industry'], [name='search'], [name='sort_by'], [name='sort_dir']"
            name="per_page"
            style="padding: 0.5rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); margin-left: 1rem;"
        >
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
        </select>
    </div>
</div>
{% endif %}
{% endif %}

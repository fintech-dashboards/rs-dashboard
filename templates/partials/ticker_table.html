{# Ticker Table Component - Client-side filtering, sorting & pagination with Alpine.js #}
{% if tickers | length == 0 %}
<!-- Empty State -->
<div style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
    <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--text-muted); font-weight: 300;">[ ]</div>
    <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 500;">No Tickers Yet</h3>
    <p style="margin-bottom: 1.5rem;">Get started by adding tickers to track their Relative Strength</p>
    <button class="btn-primary" @click="$dispatch('show-add-modal')">
        + Add Tickers
    </button>
</div>
{% else %}

<div x-data="tickerTable()" x-init="init()">
    <!-- Filters -->
    <div class="filters" style="display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <select x-model="statusFilter" @change="page = 1">
            <option value="all">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="complete">Complete</option>
            <option value="failed">Failed</option>
        </select>
        <select x-model="sectorFilter" @change="page = 1">
            <option value="all">All Sectors</option>
            <template x-for="sector in uniqueSectors" :key="sector">
                <option :value="sector" x-text="sector"></option>
            </template>
        </select>
        <select x-model="industryFilter" @change="page = 1">
            <option value="all">All Industries</option>
            <template x-for="industry in uniqueIndustries" :key="industry">
                <option :value="industry" x-text="industry"></option>
            </template>
        </select>
        <input type="text"
               placeholder="Search symbol, name, sector, industry..."
               x-model="searchFilter"
               @input="page = 1"
               style="flex: 1; min-width: 200px;">
        <span style="color: var(--text-muted); font-size: 0.875rem; margin-left: auto; align-self: center;">
            <span x-text="filteredTickers.length"></span> tickers
        </span>
    </div>

    <!-- Pagination Info & Controls (top) -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.35rem;">
                <label style="color: var(--text-muted); font-size: 0.8rem;">Per page:</label>
                <select x-model="perPage" @change="page = 1" style="padding: 0.2rem 0.4rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 0.8rem; appearance: none; -webkit-appearance: none; box-shadow: none;">
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="all">All</option>
                </select>
            </div>
            <span style="color: var(--text-muted); font-size: 0.8rem;">
                Showing <span x-text="Math.min(startIdx + 1, filteredTickers.length)"></span>-<span x-text="Math.min(endIdx, filteredTickers.length)"></span> of <span x-text="filteredTickers.length"></span>
            </span>
        </div>
        <!-- Pagination Controls -->
        <div x-show="totalPages > 1" style="display: flex; align-items: center; gap: 0.35rem;">
            <button @click="page = 1" :disabled="page === 1" style="padding: 0.2rem 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.8rem;">««</button>
            <button @click="page = Math.max(1, page - 1)" :disabled="page === 1" style="padding: 0.2rem 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.8rem;">‹</button>
            <span style="color: var(--text-muted); font-size: 0.8rem; padding: 0 0.5rem;">
                Page <span x-text="page"></span> / <span x-text="totalPages"></span>
            </span>
            <button @click="page = Math.min(totalPages, page + 1)" :disabled="page === totalPages" style="padding: 0.2rem 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.8rem;">›</button>
            <button @click="page = totalPages" :disabled="page === totalPages" style="padding: 0.2rem 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); cursor: pointer; font-size: 0.8rem;">»»</button>
        </div>
    </div>

    <!-- Table -->
    <table>
        <thead>
            <tr>
                <th @click="sort('symbol')" style="cursor: pointer;">
                    Symbol <span x-text="sortIndicator('symbol')"></span>
                </th>
                <th @click="sort('name')" style="cursor: pointer;">
                    Name <span x-text="sortIndicator('name')"></span>
                </th>
                <th @click="sort('sector')" style="cursor: pointer;">
                    Sector <span x-text="sortIndicator('sector')"></span>
                </th>
                <th @click="sort('industry')" style="cursor: pointer;">
                    Industry <span x-text="sortIndicator('industry')"></span>
                </th>
                <th @click="sort('price_count')" style="cursor: pointer;">
                    Prices <span x-text="sortIndicator('price_count')"></span>
                </th>
                <th>RS Status</th>
                <th @click="sort('rs_score')" style="cursor: pointer;">
                    RS Score <span x-text="sortIndicator('rs_score')"></span>
                </th>
                <th @click="sort('rs_percentile')" style="cursor: pointer;">
                    Percentile <span x-text="sortIndicator('rs_percentile')"></span>
                </th>
                <th>View</th>
            </tr>
        </thead>
        <tbody>
            <template x-for="ticker in paginatedTickers" :key="ticker.symbol">
                <tr>
                    <td>
                        <a :href="'https://finance.yahoo.com/quote/' + ticker.symbol"
                           target="_blank"
                           rel="noopener noreferrer"
                           style="color: var(--accent); text-decoration: none; font-weight: 600;"
                           x-text="ticker.symbol"></a>
                    </td>
                    <td x-text="(ticker.name || '—').substring(0, 25)"></td>
                    <td x-text="ticker.sector || '—'"></td>
                    <td x-text="(ticker.industry || '—').substring(0, 20)"></td>
                    <td>
                        <span :class="'status status-' + ticker.price_status">
                            <span x-text="ticker.price_status.toUpperCase()"></span>
                            <span x-show="ticker.price_status === 'complete'" x-text="' • ' + ticker.price_count + 'd'"></span>
                        </span>
                    </td>
                    <td>
                        <span :class="'status status-' + ticker.rs_status">
                            <span x-text="ticker.rs_status.toUpperCase()"></span>
                        </span>
                    </td>
                    <td>
                        <template x-if="ticker.rs_score">
                            <span :class="'score ' + (ticker.rs_score >= 110 ? 'score-high' : ticker.rs_score >= 90 ? 'score-mid' : 'score-low')"
                                  x-text="ticker.rs_score.toFixed(1)"></span>
                        </template>
                        <template x-if="!ticker.rs_score">
                            <span>—</span>
                        </template>
                    </td>
                    <td>
                        <template x-if="ticker.rs_percentile">
                            <span x-text="ticker.rs_percentile + 'th'"></span>
                        </template>
                        <template x-if="!ticker.rs_percentile">
                            <span>—</span>
                        </template>
                    </td>
                    <td>
                        <template x-if="ticker.price_status === 'complete'">
                            <button class="icon-btn"
                                    @click="$dispatch('show-chart-modal', { symbol: ticker.symbol, name: ticker.name })"
                                    title="View detailed chart">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </template>
                        <template x-if="ticker.price_status !== 'complete'">
                            <span>—</span>
                        </template>
                    </td>
                </tr>
            </template>
        </tbody>
    </table>

</div>

<script>
function tickerTable() {
    return {
        allTickers: {{ tickers | tojson }},
        sortBy: 'symbol',
        sortDir: 'asc',
        page: 1,
        perPage: '50',
        // Filters
        statusFilter: 'all',
        sectorFilter: 'all',
        industryFilter: 'all',
        searchFilter: '',

        init() {
            this.sortData();
        },

        // Unique values for dropdowns
        get uniqueSectors() {
            const sectors = [...new Set(this.allTickers.map(t => t.sector).filter(s => s))];
            return sectors.sort();
        },

        get uniqueIndustries() {
            const industries = [...new Set(this.allTickers.map(t => t.industry).filter(i => i))];
            return industries.sort();
        },

        // Filtered tickers based on all filters
        get filteredTickers() {
            const search = this.searchFilter.toLowerCase();
            return this.allTickers.filter(t => {
                // Status filter
                if (this.statusFilter !== 'all') {
                    if (this.statusFilter === 'pending' && t.price_status !== 'pending') return false;
                    if (this.statusFilter === 'complete' && t.price_status !== 'complete') return false;
                    if (this.statusFilter === 'failed' && t.price_status !== 'failed') return false;
                }
                // Sector filter
                if (this.sectorFilter !== 'all' && t.sector !== this.sectorFilter) return false;
                // Industry filter
                if (this.industryFilter !== 'all' && t.industry !== this.industryFilter) return false;
                // Search filter - match across symbol, name, sector, industry
                if (search) {
                    const symbol = (t.symbol || '').toLowerCase();
                    const name = (t.name || '').toLowerCase();
                    const sector = (t.sector || '').toLowerCase();
                    const industry = (t.industry || '').toLowerCase();
                    if (!symbol.includes(search) &&
                        !name.includes(search) &&
                        !sector.includes(search) &&
                        !industry.includes(search)) {
                        return false;
                    }
                }
                return true;
            });
        },

        get perPageNum() {
            return this.perPage === 'all' ? this.filteredTickers.length : parseInt(this.perPage);
        },

        get totalPages() {
            return Math.ceil(this.filteredTickers.length / this.perPageNum) || 1;
        },

        get startIdx() {
            return (this.page - 1) * this.perPageNum;
        },

        get endIdx() {
            return this.startIdx + this.perPageNum;
        },

        get paginatedTickers() {
            return this.filteredTickers.slice(this.startIdx, this.endIdx);
        },

        sort(column) {
            if (this.sortBy === column) {
                this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortBy = column;
                this.sortDir = 'asc';
            }
            this.sortData();
            this.page = 1;
        },

        sortData() {
            const dir = this.sortDir === 'asc' ? 1 : -1;
            const col = this.sortBy;

            this.allTickers.sort((a, b) => {
                let aVal = a[col];
                let bVal = b[col];

                // Handle nulls
                if (aVal === null || aVal === undefined) aVal = col === 'rs_score' || col === 'rs_percentile' || col === 'price_count' ? -999 : '';
                if (bVal === null || bVal === undefined) bVal = col === 'rs_score' || col === 'rs_percentile' || col === 'price_count' ? -999 : '';

                // Numeric comparison for number fields
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return (aVal - bVal) * dir;
                }

                // String comparison
                return String(aVal).localeCompare(String(bVal)) * dir;
            });
        },

        sortIndicator(column) {
            if (this.sortBy !== column) return '⇅';
            return this.sortDir === 'asc' ? '↑' : '↓';
        }
    };
}
</script>
{% endif %}

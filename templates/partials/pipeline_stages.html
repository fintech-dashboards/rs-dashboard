{# Entity-Based Pipeline Status: Single Line Compact #}
{% macro status_item(label, item) %}
<span style="display: inline-flex; align-items: center; gap: 0.2rem; font-size: 0.75rem;">
    {% if item.status == 'running' %}<span class="spinner" style="width: 8px; height: 8px;"></span>
    {% elif item.status == 'complete' %}<span style="color: var(--green);">✓</span>
    {% else %}<span style="color: var(--text-muted);">○</span>{% endif %}
    <span style="color: var(--text-muted);">{{ label }}</span>
    <span style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary);">{{ item.days }}d</span>
</span>
{% endmacro %}

<div class="stage-grid">
    <!-- STOCKS -->
    {% set stocks_running = pipeline.stocks.prices.status == 'running' or pipeline.stocks.rs_score.status == 'running' %}
    {% set stocks_complete = pipeline.stocks.prices.status == 'complete' and pipeline.stocks.rs_score.status == 'complete' %}
    <div class="stage {% if stocks_running %}active{% elif stocks_complete %}complete{% endif %}" style="display: flex; align-items: center; justify-content: space-between; gap: 0.75rem;">
        <span class="stage-name" style="font-size: 0.65rem;">STOCKS</span>
        <span style="font-size: 1rem; font-weight: 600; color: var(--text-primary);">{{ pipeline.stocks.total }}</span>
        <span style="display: flex; gap: 0.75rem; margin-left: auto;">
            {{ status_item('Prices', pipeline.stocks.prices) }}
            {{ status_item('RS', pipeline.stocks.rs_score) }}
        </span>
        {% if stocks_running %}<span class="spinner" style="width: 10px; height: 10px;"></span>
        {% elif stocks_complete %}<span style="color: var(--green);">✓</span>
        {% else %}<span style="color: var(--text-muted);">○</span>{% endif %}
    </div>

    <!-- SECTORS -->
    {% set sectors_running = pipeline.sectors.returns.status == 'running' or pipeline.sectors.rs_score.status == 'running' %}
    {% set sectors_complete = pipeline.sectors.returns.status == 'complete' and pipeline.sectors.rs_score.status == 'complete' %}
    <div class="stage {% if sectors_running %}active{% elif sectors_complete %}complete{% endif %}" style="display: flex; align-items: center; justify-content: space-between; gap: 0.75rem;">
        <span class="stage-name" style="font-size: 0.65rem;">SECTORS</span>
        <span style="font-size: 1rem; font-weight: 600; color: var(--text-primary);">{{ pipeline.sectors.total }}</span>
        <span style="display: flex; gap: 0.75rem; margin-left: auto;">
            {{ status_item('Returns', pipeline.sectors.returns) }}
            {{ status_item('RS', pipeline.sectors.rs_score) }}
        </span>
        {% if sectors_running %}<span class="spinner" style="width: 10px; height: 10px;"></span>
        {% elif sectors_complete %}<span style="color: var(--green);">✓</span>
        {% else %}<span style="color: var(--text-muted);">○</span>{% endif %}
    </div>

    <!-- INDUSTRIES -->
    {% set industries_running = pipeline.industries.returns.status == 'running' or pipeline.industries.rs_score.status == 'running' %}
    {% set industries_complete = pipeline.industries.returns.status == 'complete' and pipeline.industries.rs_score.status == 'complete' %}
    <div class="stage {% if industries_running %}active{% elif industries_complete %}complete{% endif %}" style="display: flex; align-items: center; justify-content: space-between; gap: 0.75rem;">
        <span class="stage-name" style="font-size: 0.65rem;">INDUSTRIES</span>
        <span style="font-size: 1rem; font-weight: 600; color: var(--text-primary);">{{ pipeline.industries.total }}</span>
        <span style="display: flex; gap: 0.75rem; margin-left: auto;">
            {{ status_item('Returns', pipeline.industries.returns) }}
            {{ status_item('RS', pipeline.industries.rs_score) }}
        </span>
        {% if industries_running %}<span class="spinner" style="width: 10px; height: 10px;"></span>
        {% elif industries_complete %}<span style="color: var(--green);">✓</span>
        {% else %}<span style="color: var(--text-muted);">○</span>{% endif %}
    </div>
</div>

<!-- Action Buttons -->
<div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
    {% set any_running = pipeline.stocks.prices.status == 'running' or pipeline.stocks.rs_score.status == 'running' or pipeline.sectors.returns.status == 'running' or pipeline.sectors.rs_score.status == 'running' or pipeline.industries.returns.status == 'running' or pipeline.industries.rs_score.status == 'running' %}

    <button class="stage-btn"
            hx-post="/api/refresh-all"
            hx-target="#pipeline-stages"
            hx-confirm="Start full refresh (prices → returns → RS)?"
            {% if any_running %}disabled{% endif %}>
        Refresh All
    </button>

    <button class="stage-btn"
            hx-post="/api/recalculate-rs"
            hx-target="#pipeline-stages"
            hx-confirm="Recalculate RS for backfill days?"
            {% if any_running %}disabled{% endif %}>
        Recalculate RS
    </button>

    <button class="stage-btn"
            @click="$dispatch('show-add-modal')"
            style="margin-left: auto;">
        + Add Tickers
    </button>

    <button class="stage-btn"
            @click="$dispatch('show-weights-modal')">
        RS Weights
    </button>

    <button class="stage-btn"
            @click="$dispatch('show-advanced-modal')">
        Advanced
    </button>
</div>
